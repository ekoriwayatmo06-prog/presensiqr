<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Presensi QR Code</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <!-- Tambahkan Chart.js untuk grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #reader { width: 100%; border: none !important; border-radius: 12px; overflow: hidden; background-color: #000; }
        #reader video { border-radius: 12px; object-fit: cover; width: 100% !important; height: 100% !important; }
        #reader__scan_region { background: #000; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-24"> <!-- pb ditingkatkan agar tidak tertutup nav -->

    <header class="bg-blue-600 text-white p-4 sticky top-0 z-50 shadow-md">
        <div class="flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i data-lucide="scan-line"></i> PresensiQR
            </h1>
            <span id="current-date" class="text-sm opacity-90"></span>
        </div>
    </header>

    <main class="p-4 max-w-4xl mx-auto">
        
        <!-- TAB SCAN -->
        <section id="scan" class="tab-content active">
            <div class="bg-white p-6 rounded-2xl shadow-sm mb-6 border border-slate-200 text-center">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-slate-700">Scan QR Code</h2>
                    <select id="camera-selection" class="text-[10px] p-2 border rounded-lg bg-slate-50 outline-none max-w-[160px]" onchange="changeCamera(this.value)">
                        <option value="">Mencari Kamera...</option>
                    </select>
                </div>
                
                <div class="relative bg-black rounded-xl overflow-hidden mb-4 aspect-square md:aspect-video flex items-center justify-center">
                    <div id="reader" style="z-index: 1;"></div>
                    <div id="camera-loading" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900 text-white z-20">
                        <i data-lucide="loader-2" class="animate-spin mb-2 text-blue-400"></i>
                        <span class="text-xs">Menyiapkan Kamera...</span>
                    </div>
                </div>
                <div id="scan-feedback" class="mt-4 p-3 rounded-lg hidden text-sm font-bold animate-bounce"></div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <button onclick="switchTab('manual')" class="bg-amber-500 text-white p-4 rounded-xl flex flex-col items-center gap-2 shadow-sm active:scale-95 transition-transform">
                    <i data-lucide="user-plus"></i>
                    <span class="text-sm font-medium">Input Manual</span>
                </button>
                <button onclick="switchTab('laporan')" class="bg-indigo-500 text-white p-4 rounded-xl flex flex-col items-center gap-2 shadow-sm active:scale-95 transition-transform">
                    <i data-lucide="file-text"></i>
                    <span class="text-sm font-medium">Laporan Hari Ini</span>
                </button>
            </div>
        </section>

        <!-- TAB SISWA -->
        <section id="siswa" class="tab-content">
            <div class="flex flex-wrap justify-between items-center mb-6 gap-3">
                <h2 class="text-xl font-bold text-slate-800">Data Siswa</h2>
                <div class="flex flex-wrap gap-2">
                    <button onclick="downloadCSVTemplate()" class="bg-slate-200 text-slate-700 px-3 py-2 rounded-lg flex items-center gap-2 text-sm shadow-sm hover:bg-slate-300 transition-colors">
                        <i data-lucide="download" size="18"></i> Template
                    </button>
                    <button onclick="openSiswaModal()" class="bg-blue-600 text-white px-3 py-2 rounded-lg flex items-center gap-2 text-sm shadow-sm">
                        <i data-lucide="plus-circle" size="18"></i> Tambah
                    </button>
                    <label class="bg-emerald-600 text-white px-3 py-2 rounded-lg flex items-center gap-2 text-sm shadow-sm cursor-pointer">
                        <i data-lucide="file-up" size="18"></i> Impor CSV
                        <input type="file" id="csv-file-input" class="hidden" accept=".csv" onchange="importSiswaCSV(event)">
                    </label>
                </div>
            </div>

            <div class="bg-slate-800 p-4 rounded-2xl shadow-md mb-6 border border-slate-700 text-white">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Manajemen Cadangan (Backup)</p>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="exportFullData()" class="bg-slate-700 hover:bg-slate-600 p-3 rounded-xl flex items-center justify-center gap-2 text-xs font-bold transition-colors">
                        <i data-lucide="download-cloud" size="16"></i> EKSPOR BACKUP
                    </button>
                    <label class="bg-slate-700 hover:bg-slate-600 p-3 rounded-xl flex items-center justify-center gap-2 text-xs font-bold transition-colors cursor-pointer">
                        <i data-lucide="upload-cloud" size="16"></i> IMPOR BACKUP
                        <input type="file" id="backup-file-input" class="hidden" accept=".json" onchange="importFullData(event)">
                    </label>
                </div>
            </div>

            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 mb-6 space-y-4">
                <p class="text-xs font-bold text-slate-500 uppercase tracking-wider">Fitur Unduh QR Massal</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <button onclick="generateBulkQRReport('all')" class="bg-blue-700 text-white py-3 px-4 rounded-xl text-xs font-bold flex items-center justify-center gap-2 shadow-sm">
                        <i data-lucide="qr-code" size="16"></i> UNDUH QR SEMUA SISWA
                    </button>
                    <div class="flex gap-2">
                        <select id="filter-kelas-unduh" class="flex-1 p-2 text-xs rounded-lg border border-slate-200 outline-none">
                            <option value="">Pilih Kelas...</option>
                        </select>
                        <button onclick="generateBulkQRReport('kelas')" class="bg-indigo-600 text-white py-2 px-4 rounded-lg text-xs font-bold flex items-center gap-2 shadow-sm">
                            <i data-lucide="printer" size="14"></i> PER KELAS
                        </button>
                    </div>
                </div>
            </div>

            <div class="mb-4 relative">
                <input type="text" id="search-siswa" placeholder="Cari nama atau kelas..." class="w-full p-3 pl-10 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none" onkeyup="renderSiswaList()">
                <i data-lucide="search" class="absolute left-3 top-3 text-slate-400" size="18"></i>
            </div>
            <div id="siswa-list" class="space-y-3"></div>
        </section>

        <!-- TAB STATISTIK -->
        <section id="statistik" class="tab-content">
            <h2 class="text-xl font-bold text-slate-800 mb-6">Tren Keterlambatan</h2>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-6">
                <p class="text-[10px] font-bold text-slate-500 uppercase mb-4">Jumlah Terlambat (7 Hari Terakhir)</p>
                <div class="relative h-64 w-full">
                    <canvas id="delayChart"></canvas>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                    <p class="text-[10px] font-bold text-red-500 uppercase">Total Terlambat</p>
                    <h3 id="stat-total-terlambat" class="text-2xl font-bold text-red-700">0</h3>
                </div>
                <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                    <p class="text-[10px] font-bold text-green-500 uppercase">Total Hadir</p>
                    <h3 id="stat-total-hadir" class="text-2xl font-bold text-green-700">0</h3>
                </div>
            </div>
        </section>

        <!-- TAB LAPORAN -->
        <section id="laporan" class="tab-content">
            <div class="flex flex-wrap justify-between items-center mb-4 gap-3">
                <h2 class="text-xl font-bold text-slate-800">Laporan Kehadiran</h2>
                <div class="flex gap-2">
                    <button onclick="printLaporan('all')" class="bg-indigo-600 text-white px-3 py-2 rounded-lg flex items-center gap-2 text-xs shadow-sm">
                        <i data-lucide="printer" size="16"></i> Hari Ini
                    </button>
                    <button onclick="showPrintKelasModal()" class="bg-blue-600 text-white px-3 py-2 rounded-lg flex items-center gap-2 text-xs shadow-sm">
                        <i data-lucide="calendar-search" size="16"></i> Filter Laporan
                    </button>
                </div>
            </div>
            <div class="mb-4 relative">
                <input type="text" id="search-laporan" placeholder="Filter nama atau kelas..." class="w-full p-3 pl-10 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none" onkeyup="renderLaporan()">
                <i data-lucide="filter" class="absolute left-3 top-3 text-slate-400" size="18"></i>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="p-4 font-semibold">Siswa</th>
                                <th class="p-4 font-semibold">Status</th>
                                <th class="p-4 font-semibold">Waktu</th>
                                <th class="p-4 font-semibold">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="laporan-table-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- TAB MANUAL -->
        <section id="manual" class="tab-content">
            <h2 class="text-xl font-bold text-slate-800 mb-6">Input Manual</h2>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 space-y-4">
                <input type="text" id="manual-search-input" placeholder="Cari nama siswa..." class="w-full p-3 rounded-xl border border-slate-200" onkeyup="searchManualSiswa()">
                <div id="manual-search-results" class="mt-2 max-h-40 overflow-y-auto border border-slate-100 rounded-xl hidden"></div>
                <div id="selected-student-info" class="hidden p-4 bg-blue-50 border border-blue-100 rounded-xl flex justify-between items-center font-bold text-blue-700">
                    <span id="selected-name"></span>
                    <button onclick="clearSelectedStudent()" class="text-red-500"><i data-lucide="x-circle"></i></button>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="setManualStatus('Sakit')" id="btn-Sakit" class="status-btn border py-3 rounded-xl text-xs font-bold">SAKIT</button>
                    <button onclick="setManualStatus('Izin')" id="btn-Izin" class="status-btn border py-3 rounded-xl text-xs font-bold">IZIN</button>
                    <button onclick="setManualStatus('Alpha')" id="btn-Alpha" class="status-btn border py-3 rounded-xl text-xs font-bold">ALPHA</button>
                    <button onclick="setManualStatus('Terlambat')" id="btn-Terlambat" class="status-btn border py-3 rounded-xl text-xs font-bold">TERLAMBAT</button>
                </div>
                <button onclick="submitManualAttendance()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg">SIMPAN DATA</button>
            </div>
        </section>
    </main>

    <!-- NAV BAR - 4 MENU -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around p-3 z-50">
        <button onclick="switchTab('scan')" class="nav-link text-blue-600 flex flex-col items-center" id="nav-scan">
            <i data-lucide="camera"></i><span class="text-[10px] mt-1 font-bold">SCAN</span>
        </button>
        <button onclick="switchTab('siswa')" class="nav-link text-slate-400 flex flex-col items-center" id="nav-siswa">
            <i data-lucide="users"></i><span class="text-[10px] mt-1 font-medium">SISWA</span>
        </button>
        <button onclick="switchTab('statistik')" class="nav-link text-slate-400 flex flex-col items-center" id="nav-statistik">
            <i data-lucide="bar-chart-3"></i><span class="text-[10px] mt-1 font-medium">STATISTIK</span>
        </button>
        <button onclick="switchTab('laporan')" class="nav-link text-slate-400 flex flex-col items-center" id="nav-laporan">
            <i data-lucide="clipboard-list"></i><span class="text-[10px] mt-1 font-medium">LAPORAN</span>
        </button>
    </nav>

    <!-- MODAL SISWA -->
    <div id="siswa-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-[60]">
        <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
            <h3 id="modal-title" class="text-lg font-bold mb-4">Tambah Siswa</h3>
            <div class="space-y-4">
                <input type="hidden" id="edit-index">
                <input type="text" id="siswa-nama" class="w-full p-3 rounded-xl border border-slate-200" placeholder="Nama Lengkap">
                <input type="text" id="siswa-kelas" class="w-full p-3 rounded-xl border border-slate-200" placeholder="Kelas">
                <input type="text" id="siswa-id" class="w-full p-3 rounded-xl border border-slate-200" placeholder="ID Siswa / NIS">
                <div class="flex gap-2">
                    <button onclick="closeSiswaModal()" class="flex-1 py-3 border rounded-xl font-medium">Batal</button>
                    <button onclick="saveSiswa()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PRINT/FILTER LAPORAN -->
    <div id="print-kelas-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-[60]">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6">
            <h3 class="font-bold mb-4 text-slate-800">Filter Laporan Pertanggal</h3>
            <div class="space-y-3">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Pilih Tanggal</label>
                    <input type="date" id="select-print-date" class="w-full p-3 rounded-xl border outline-none text-sm">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Pilih Kelas</label>
                    <select id="select-print-kelas" class="w-full p-3 rounded-xl border outline-none text-sm">
                        <option value="all">Semua Kelas</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="closePrintKelasModal()" class="flex-1 py-2 border rounded-xl text-sm">Batal</button>
                <button onclick="executePrintLaporan()" class="flex-1 py-2 bg-blue-600 text-white rounded-xl font-bold text-sm">Cetak Laporan</button>
            </div>
        </div>
    </div>

    <script>
        let dataSiswa = JSON.parse(localStorage.getItem('db_siswa')) || [];
        let dataPresensi = JSON.parse(localStorage.getItem('db_presensi')) || [];
        let html5QrCode = null;
        let selectedStudentId = "";
        let manualStatusSelected = "";
        let currentCameraId = null;
        let delayChart = null;

        function playBeep() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.type = 'sine'; 
                oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.2);
            } catch(e) {}
        }

        function playSiren() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const playTone = (freq, start, duration) => {
                    const oscillator = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioCtx.destination);
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(freq, audioCtx.currentTime + start);
                    oscillator.frequency.exponentialRampToValueAtTime(freq * 1.5, audioCtx.currentTime + start + duration);
                    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime + start);
                    gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + start + duration);
                    oscillator.start(audioCtx.currentTime + start);
                    oscillator.stop(audioCtx.currentTime + start + duration);
                };
                playTone(440, 0, 0.4);
                playTone(440, 0.5, 0.4);
                playTone(440, 1.0, 0.6);
            } catch(e) {}
        }

        window.onload = () => {
            lucide.createIcons();
            document.getElementById('current-date').innerText = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const todayISO = new Date().toISOString().split('T')[0];
            document.getElementById('select-print-date').value = todayISO;
            refreshAll();
            setTimeout(initScanner, 500);
        };

        function refreshAll() {
            renderSiswaList();
            renderLaporan();
            updateKelasFilter();
            updateStatistik();
        }

        function exportFullData() {
            const backupData = { siswa: dataSiswa, presensi: dataPresensi, exportedAt: new Date().toISOString() };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData));
            const dl = document.createElement('a');
            dl.setAttribute("href", dataStr);
            dl.setAttribute("download", "backup_presensi_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(dl); dl.click(); dl.remove();
        }

        function importFullData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported.siswa && imported.presensi) {
                        if (confirm("Timpa data saat ini?")) {
                            dataSiswa = imported.siswa; dataPresensi = imported.presensi;
                            localStorage.setItem('db_siswa', JSON.stringify(dataSiswa));
                            localStorage.setItem('db_presensi', JSON.stringify(dataPresensi));
                            refreshAll(); alert("Backup dipulihkan!");
                        }
                    }
                } catch (err) { alert("Gagal!"); }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        async function initScanner() {
            const loadingEl = document.getElementById('camera-loading');
            const cameraSelect = document.getElementById('camera-selection');
            try {
                if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
                const cameras = await Html5Qrcode.getCameras();
                if (cameras && cameras.length > 0) {
                    cameraSelect.innerHTML = cameras.map(cam => `<option value="${cam.id}">${cam.label || 'Kamera ' + (cameras.indexOf(cam)+1)}</option>`).join('');
                    if (!currentCameraId) {
                        const backCam = cameras.find(c => c.label.toLowerCase().includes('back') || c.label.toLowerCase().includes('rear'));
                        currentCameraId = backCam ? backCam.id : cameras[0].id;
                    }
                    cameraSelect.value = currentCameraId;
                    await startCamera(currentCameraId);
                }
            } catch (err) { 
                loadingEl.innerHTML = "<span class='text-red-400'>Akses Kamera Gagal</span>";
            }
        }

        async function startCamera(cameraId) {
            const loadingEl = document.getElementById('camera-loading');
            loadingEl.classList.remove('hidden');
            try {
                if (html5QrCode && html5QrCode.isScanning) await html5QrCode.stop();
                await html5QrCode.start(cameraId, { fps: 15, qrbox: (w, h) => { let s = Math.min(w, h) * 0.8; return { width: s, height: s }; }, aspectRatio: 1.0 }, (text) => {
                    const now = new Date();
                    const hours = now.getHours();
                    const minutes = now.getMinutes();
                    let status = "Hadir";
                    if (hours > 6 || (hours === 6 && minutes > 50)) status = "Terlambat";
                    processAttendance(text, status);
                }, () => {});
                loadingEl.classList.add('hidden');
            } catch (err) { loadingEl.classList.remove('hidden'); }
        }

        async function changeCamera(id) { currentCameraId = id; await startCamera(id); }

        async function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(el => el.classList.replace('text-blue-600', 'text-slate-400'));
            const navId = (tabId === 'manual') ? 'nav-scan' : `nav-${tabId}`;
            if (document.getElementById(navId)) document.getElementById(navId).classList.replace('text-slate-400', 'text-blue-600');
            
            if (tabId === 'scan') setTimeout(initScanner, 200); 
            else if (html5QrCode && html5QrCode.isScanning) await html5QrCode.stop();
            
            if (tabId === 'statistik') updateStatistik();
            refreshAll(); lucide.createIcons();
        }

        function processAttendance(sid, status) {
            const student = dataSiswa.find(s => s.id === sid);
            if(!student) return showFeedback("QR Tidak Terdaftar!", "bg-red-500 text-white");
            
            const today = new Date().toLocaleDateString();
            if(dataPresensi.some(p => p.id === sid && p.tanggal === today)) {
                showFeedback(`${student.nama} Sudah Absen`, "bg-amber-500 text-white");
                playBeep();
            } else {
                const waktuScan = new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
                dataPresensi.push({ 
                    id: sid, nama: student.nama, kelas: student.kelas, status, 
                    waktu: waktuScan, 
                    tanggal: today, timestamp: new Date().getTime() 
                });
                localStorage.setItem('db_presensi', JSON.stringify(dataPresensi));
                
                if (status === "Terlambat") {
                    showFeedback(`TERLAMBAT: ${student.nama}`, "bg-red-600 text-white ring-4 ring-red-200");
                    playSiren();
                    setTimeout(() => printSlipTerlambat(student, waktuScan), 1000);
                } else {
                    showFeedback(`BERHASIL: ${student.nama}`, "bg-green-500 text-white");
                    playBeep();
                }
                refreshAll();
            }
        }

        function updateStatistik() {
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                last7Days.push(d.toLocaleDateString());
            }

            const dataPoints = last7Days.map(date => {
                return dataPresensi.filter(p => p.tanggal === date && p.status === 'Terlambat').length;
            });

            const ctx = document.getElementById('delayChart').getContext('2d');
            if (delayChart) delayChart.destroy();

            delayChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: last7Days.map(d => {
                        const parts = d.split('/');
                        return parts[0] + '/' + parts[1];
                    }),
                    datasets: [{
                        label: 'Siswa Terlambat',
                        data: dataPoints,
                        backgroundColor: '#ef4444',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });

            document.getElementById('stat-total-terlambat').innerText = dataPresensi.filter(p => p.status === 'Terlambat').length;
            document.getElementById('stat-total-hadir').innerText = dataPresensi.filter(p => p.status === 'Hadir').length;
        }

        function showFeedback(msg, cssClass) {
            const fb = document.getElementById('scan-feedback');
            fb.className = `mt-4 p-4 rounded-xl block text-center shadow-lg transition-all ${cssClass}`;
            fb.innerText = msg; fb.classList.remove('hidden');
            setTimeout(() => fb.classList.add('hidden'), 4000);
        }

        function printSlipTerlambat(student, waktu) {
            const win = window.open('', '_blank');
            const dateStr = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            win.document.write(`<html><head><title>Surat Izin Masuk Kelas</title><style>body { font-family: 'Courier New', Courier, monospace; width: 80mm; padding: 5mm; margin: 0; } .header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 3mm; margin-bottom: 3mm; } .content { font-size: 12px; line-height: 1.4; } .title { font-weight: bold; text-align: center; text-decoration: underline; margin-bottom: 3mm; display: block; } .row { display: flex; justify-content: space-between; margin-bottom: 1mm; } .footer { margin-top: 5mm; border-top: 1px dashed #000; padding-top: 3mm; font-size: 10px; } .signature-box { margin-top: 8mm; display: flex; justify-content: space-between; } .sign-area { text-align: center; width: 45%; } .sign-space { height: 12mm; } @media print { @page { margin: 0; } body { margin: 0; } }</style></head><body onload="window.print(); setTimeout(()=>window.close(), 500);"><div class="header"><h2 style="margin:0; font-size: 16px;">SMP NEGERI KOTA</h2><p style="margin:0; font-size: 10px;">Surat Keterangan Terlambat</p></div><div class="content"><span class="title">IZIN MASUK KELAS</span><div class="row"><span>Tanggal:</span> <span>${dateStr}</span></div><div class="row"><span>Jam Scan:</span> <span>${waktu} WIB</span></div><div class="row"><span>Status:</span> <span style="font-weight:bold;">TERLAMBAT (>06.50)</span></div><hr style="border:0; border-top:1px solid #eee;"><div class="row"><span>Nama:</span> <span>${student.nama}</span></div><div class="row"><span>Kelas:</span> <span>${student.kelas}</span></div><div class="row"><span>NIS/ID:</span> <span>${student.id}</span></div><p style="margin-top:5mm; font-size: 11px;">Siswa tersebut di atas dinyatakan terlambat mengikuti kegiatan sekolah. Mohon kiranya diperkenankan masuk ke kelas.</p></div><div class="signature-box"><div class="sign-area"><span>Piket/Guru BK</span><div class="sign-space"></div><span>(................)</span></div><div class="sign-area"><span>Guru Pengajar</span><div class="sign-space"></div><span>(................)</span></div></div><div class="footer">* Lembar ini wajib diserahkan kepada guru pengajar di kelas.</div></body></html>`);
            win.document.close();
        }

        function renderSiswaList() {
            const q = document.getElementById('search-siswa').value.toLowerCase();
            const listEl = document.getElementById('siswa-list');
            listEl.innerHTML = '';
            const filtered = dataSiswa.filter(s => s.nama.toLowerCase().includes(q) || s.kelas.toLowerCase().includes(q));
            filtered.forEach((s) => {
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col gap-3";
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="bg-blue-100 p-2 rounded-lg text-blue-600"><i data-lucide="user"></i></div>
                            <div>
                                <h4 class="font-bold text-slate-800 text-sm">${s.nama}</h4>
                                <p class="text-[10px] text-slate-500">${s.kelas} â€¢ ID: ${s.id}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openSiswaModalById('${s.id}')" class="p-2 text-slate-400"><i data-lucide="edit-2" size="14"></i></button>
                            <button onclick="handleDeleteSiswa('${s.id}')" class="p-2 text-red-500"><i data-lucide="trash-2" size="14"></i></button>
                        </div>
                    </div>
                    <button onclick="printPersonalQR('${s.id}')" class="w-full py-2 bg-slate-50 text-slate-600 text-[10px] font-bold rounded-lg border">CETAK QR</button>`;
                listEl.appendChild(card);
            });
            lucide.createIcons();
        }

        function renderLaporan() {
            const q = document.getElementById('search-laporan').value.toLowerCase();
            const body = document.getElementById('laporan-table-body');
            const today = new Date().toLocaleDateString();
            body.innerHTML = '';
            const filtered = dataPresensi.filter(p => p.tanggal === today && (p.nama.toLowerCase().includes(q) || p.kelas.toLowerCase().includes(q))).reverse();
            filtered.forEach(p => {
                const statusColor = p.status === 'Terlambat' ? 'bg-red-100 text-red-700' : (p.status === 'Hadir' ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700');
                body.innerHTML += `
                    <tr>
                        <td class="p-4"><div class="font-bold text-xs">${p.nama}</div><div class="text-[9px] text-slate-500">${p.kelas}</div></td>
                        <td class="p-4"><span class="px-2 py-1 rounded-full text-[9px] font-bold ${statusColor}">${p.status}</span></td>
                        <td class="p-4 text-[10px] text-slate-600">${p.waktu}</td>
                        <td class="p-4"><button onclick="printLaporan('siswa', '${p.id}')"><i data-lucide="history" size="14"></i></button></td>
                    </tr>`;
            });
            lucide.createIcons();
        }

        function openSiswaModal(idx = null) {
            document.getElementById('siswa-modal').classList.replace('hidden', 'flex');
            if(idx !== null) {
                const s = dataSiswa[idx];
                document.getElementById('edit-index').value = idx;
                document.getElementById('siswa-nama').value = s.nama;
                document.getElementById('siswa-kelas').value = s.kelas;
                document.getElementById('siswa-id').value = s.id;
            } else {
                document.getElementById('edit-index').value = "";
                document.getElementById('siswa-nama').value = "";
                document.getElementById('siswa-kelas').value = "";
                document.getElementById('siswa-id').value = "";
            }
        }
        function closeSiswaModal() { document.getElementById('siswa-modal').classList.replace('flex', 'hidden'); }
        function saveSiswa() {
            const idx = document.getElementById('edit-index').value;
            const obj = { nama: document.getElementById('siswa-nama').value.trim(), kelas: document.getElementById('siswa-kelas').value.trim(), id: document.getElementById('siswa-id').value.trim() };
            if(!obj.nama || !obj.id) return alert("Lengkapi data!");
            if(idx !== "") dataSiswa[idx] = obj; else dataSiswa.push(obj);
            localStorage.setItem('db_siswa', JSON.stringify(dataSiswa));
            refreshAll(); closeSiswaModal();
        }
        function openSiswaModalById(sid) { const i = dataSiswa.findIndex(s => s.id === sid); if(i !== -1) openSiswaModal(i); }
        function handleDeleteSiswa(sid) { if(confirm("Hapus siswa?")) { dataSiswa = dataSiswa.filter(s => s.id !== sid); localStorage.setItem('db_siswa', JSON.stringify(dataSiswa)); refreshAll(); } }
        
        function updateKelasFilter() {
            const list = [...new Set(dataSiswa.map(s => s.kelas))].sort();
            document.getElementById('filter-kelas-unduh').innerHTML = '<option value="">Pilih...</option>' + list.map(k => `<option value="${k}">${k}</option>`).join('');
            document.getElementById('select-print-kelas').innerHTML = '<option value="all">Semua Kelas</option>' + list.map(k => `<option value="${k}">${k}</option>`).join('');
        }

        function searchManualSiswa() {
            const q = document.getElementById('manual-search-input').value.toLowerCase();
            const res = document.getElementById('manual-search-results');
            if(q.length < 1) { res.classList.add('hidden'); return; }
            const filtered = dataSiswa.filter(s => s.nama.toLowerCase().includes(q)).slice(0, 5);
            res.innerHTML = filtered.map(s => `<div onclick="selectStudent('${s.id}', '${s.nama}')" class="p-3 border-b cursor-pointer text-xs bg-slate-50">${s.nama} (${s.kelas})</div>`).join('');
            res.classList.remove('hidden');
        }
        function selectStudent(id, nama) { selectedStudentId = id; document.getElementById('selected-name').innerText = nama; document.getElementById('selected-student-info').classList.remove('hidden'); document.getElementById('manual-search-results').classList.add('hidden'); }
        function clearSelectedStudent() { selectedStudentId = ""; document.getElementById('selected-student-info').classList.add('hidden'); }
        function setManualStatus(st) { manualStatusSelected = st; document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('bg-blue-600', 'text-white')); document.getElementById(`btn-${st}`).classList.add('bg-blue-600', 'text-white'); }
        function submitManualAttendance() { if(!selectedStudentId || !manualStatusSelected) return alert("Lengkapi!"); processAttendance(selectedStudentId, manualStatusSelected); clearSelectedStudent(); refreshAll(); }
        
        function showPrintKelasModal() {
            document.getElementById('print-kelas-modal').classList.replace('hidden', 'flex');
        }
        function closePrintKelasModal() { document.getElementById('print-kelas-modal').classList.replace('flex', 'hidden'); }
        
        function executePrintLaporan() {
            const rawDate = document.getElementById('select-print-date').value;
            if(!rawDate) return alert("Pilih tanggal!");
            const targetKelas = document.getElementById('select-print-kelas').value;
            const d = new Date(rawDate);
            const formattedDate = d.toLocaleDateString(); 
            printLaporanFiltered(formattedDate, targetKelas);
            closePrintKelasModal();
        }

        function printPersonalQR(sid) {
            const s = dataSiswa.find(x => x.id === sid); if (!s) return;
            const win = window.open('', '_blank');
            win.document.write(`<html><head><title>${s.nama}</title><script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script></head><body onload="new QRCode(document.getElementById('q'), {text:'${s.id}', width:150, height:150}); window.print();" style="text-align:center; padding:50px; font-family:sans-serif;"><div style="border:2px solid #000; display:inline-block; padding:20px; border-radius:15px;"><h3>KARTU PRESENSI</h3><div id="q" style="margin:20px auto; width:150px;"></div><h4>${s.nama}</h4><p>${s.kelas}</p></div></body></html>`);
            win.document.close();
        }

        function generateBulkQRReport(type) {
            let target = (type === 'all') ? dataSiswa : dataSiswa.filter(s => s.kelas === document.getElementById('filter-kelas-unduh').value);
            if (target.length === 0) return alert("Kosong!");
            const win = window.open('', '_blank');
            win.document.write(`<html><head><script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script><style>.g{display:grid; grid-template-columns:repeat(3,1fr); gap:10px;} .c{border:1px solid #000; padding:10px; text-align:center; font-family:sans-serif;}</style></head><body onload="r()"><div class="g" id="g"></div><script>function r(){ const d = ${JSON.stringify(target)}; const g = document.getElementById('g'); d.forEach((s, i) => { const div = document.createElement('div'); div.className='c'; div.innerHTML='<h5>'+s.nama+'</h5><div id="q'+i+'"></div><p style="font-size:10px">'+s.kelas+'</p>'; g.appendChild(div); new QRCode(document.getElementById('q'+i), {text:s.id, width:80, height:80}); }); setTimeout(()=>window.print(), 500); }<\/script></body></html>`);
            win.document.close();
        }

        function printLaporan(type, val = null) {
            const today = new Date().toLocaleDateString();
            if(type === 'all') printLaporanFiltered(today, 'all');
            else if(type === 'siswa') printLaporanFiltered(null, 'siswa', val);
        }

        function printLaporanFiltered(dateStr, kelas, sid = null) {
            let filtered = [];
            let displayTitle = "Laporan Presensi";
            if (sid) {
                filtered = dataPresensi.filter(p => p.id === sid);
                displayTitle = "Riwayat Presensi Siswa";
            } else if (kelas === 'all') {
                filtered = dataPresensi.filter(p => p.tanggal === dateStr);
                displayTitle = "Laporan Semua Kelas - Tanggal " + dateStr;
            } else {
                filtered = dataPresensi.filter(p => p.tanggal === dateStr && p.kelas === kelas);
                displayTitle = "Laporan Kelas " + kelas + " - Tanggal " + dateStr;
            }
            if (filtered.length === 0) return alert("Tidak ada data presensi untuk kriteria tersebut.");
            const win = window.open('', '_blank');
            win.document.write(`<html><head><title>Cetak Laporan</title><style>body{font-family:sans-serif; padding:20px;} table{width:100%; border-collapse:collapse; margin-top:20px;} th,td{border:1px solid #ddd; padding:10px; text-align:left; font-size:12px;} th{background:#f8f9fa;} h2{margin:0; font-size:18px;} .meta{margin-top:5px; color:#666; font-size:12px;}</style></head><body><h2>${displayTitle}</h2><p class="meta">Dicetak pada: ${new Date().toLocaleString('id-ID')}</p><table><thead><tr><th>No</th><th>Nama</th><th>Kelas</th><th>Status</th><th>Waktu</th><th>Tanggal</th></tr></thead><tbody>${filtered.map((p,i)=>`<tr><td>${i+1}</td><td>${p.nama}</td><td>${p.kelas}</td><td>${p.status}</td><td>${p.waktu}</td><td>${p.tanggal}</td></tr>`).join('')}</tbody></table><script>window.print();<\/script></body></html>`);
            win.document.close();
        }

        function downloadCSVTemplate() {
            const csv = "data:text/csv;charset=utf-8,Nama,Kelas,ID Siswa\nBudi,7A,123";
            const link = document.createElement("a"); link.setAttribute("href", encodeURI(csv)); link.setAttribute("download", "template.csv"); document.body.appendChild(link); link.click(); link.remove();
        }
        function importSiswaCSV(e) {
            const file = e.target.files[0]; const reader = new FileReader();
            reader.onload = (event) => {
                const lines = event.target.result.split('\n');
                lines.forEach((line, i) => { if (i === 0 || !line.trim()) return; const cols = line.split(','); if (cols.length >= 3) dataSiswa.push({ nama: cols[0].trim(), kelas: cols[1].trim(), id: cols[2].trim() }); });
                localStorage.setItem('db_siswa', JSON.stringify(dataSiswa)); refreshAll();
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
